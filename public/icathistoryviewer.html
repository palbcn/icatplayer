<!DOCTYPE html><html lang="en">
<head>
<meta charset="utf-8">
<title>iCat history viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<link rel="shortcut icon" href="icaticon.png" />
</head>
<body>
<header>
<a target="_blank" href="http://catradio.cat/icat">
<img id="logo" src="icat.png"></img>
</a>
<p id="info-songs"></p>
</header>
<ul id="played">
</ul>

<footer>
<p id="info-server"></p>
</footer>
</body>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>
$(function(){ 

  String.prototype.wbr = function(num) {  
      var r =  this.replace ( RegExp("(\\w{" + (num?num:10) + "})(\\w)", "g"),
      function(match,submatch1,submatch2){
        return submatch1 + "<wbr>" + submatch2
      }
    )
    return r
  }


  const YOUTUBESEARCH="https://www.youtube.com/results?search_query=";

  let dmy = ts => new Date(ts).toLocaleString('en-GB').slice(0,-3);
  
  function buildSong(song) {
    var $li=$('<li id="'+song.timestamp+'"/>');
    var $a=$('<a target="_blank"/>')
      .attr('href',YOUTUBESEARCH+encodeURIComponent(song.artist+' - '+song.title+' - '));
    var $img=$('<img/>')
      .attr('src',song.cover);
    $a.append($img);  
    $a.append($('<p class="timestamp">')
      .text(dmy(song.timestamp)));          
    $a.append($('<p class="artist">')
      .html(song.artist.wbr()));
    $a.append($('<p class="song">')
      .html(song.title.wbr()));
    $li.append($a);
    return $li;
  };

  function rebuildSongs(songs) {
    console.log(songs);
    
    let firstd = dmy(songs[0].timestamp);
    let lastd = dmy(songs[songs.length-1].timestamp);
    
    $("#info-songs").text(`${songs.length} songs from ${firstd} to ${lastd}`);    
    
    $("#played").empty();
    songs.map(function(song){
      $("#played").append(buildSong(song));
    })
  }
  function setInfo(info) {
    console.log(info);
    $("#info-server").text(`${info.serverfn} serving ${info.icatfn} at ${info.hostname} since ${dmy(info.started)}`);    
  }
       
  $.getJSON('/info',setInfo);
  
  $.getJSON('/history',rebuildSongs);

  
})

</script>
</html>